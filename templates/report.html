<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">

<title>Project assignment results</title>
<meta name="description" content="Project assignment results">
<meta name="author" content="Automatic results generator">

<link href="report.css" rel="stylesheet" type="text/css" >
<script type="text/javascript" src="sorttable.js" ></script>
<script type="text/javascript" src="jquery-2.1.1.min.js" ></script>
<script type="text/javascript" src="jquery.sparkline.min.js" ></script>
<script type="text/javascript" src="jquery.fixedheadertable.min.js"></script>
<script type="text/javascript">
/* <![CDATA[ */
$(function() { $('.bar').sparkline('html', {type: 'bar'});
               /*$('.selectionmatrix').fixedHeaderTable({footer: false, 
                                                       cloneHeadToFoot: false, 
                                                       fixedColumn: true }); */
              });
/* ]]> */
</script>
</head>

<body>
<h1>Selections</h1>
<p>Report generated on {{ datetime.datetime.now().strftime('%c') }}</p>

<table class='selectionmatrix'>
<colgroup class='names'/>

{% for l in lecturers %}
  <colgroup span={{c[l]}} class='lect' id='{{'col_'+l}}'/>
{% endfor %}
<thead>
<tr><th/>{% for l in lecturers %}<th colspan={{c[l]}}>{{l}}{% endfor %}</tr>
<tr>
  <th>Project</th>
  {% for p in projects %}
  <th class=sel{{ p in selected }}
      title='{{'%s (%s)' % (','.join(studentsbyproject.get(p, [])),
                            projectdescriptions.get(p, ''))}}'>
      {{Project(p).number}}
  </th>
  {% endfor %}
</tr>
<tr><td>Min</td>{% for p in projects %} <td>{{minperproject[p]}}</td> {% endfor %}</tr>
<tr><td>Students</td>{% for p in projects %} <td>{{nstudentsbyproject[p]}}</td> {% endfor %}</tr>
<tr><td>Max</td>{% for p in projects %} <td>{{maxperproject[p]}}</td> {% endfor %}</tr>
</thead>

<tbody>
  {% for s in students %}
    {% set n = studentnames[s] %}
    <tr>
      <th class="names" title="{{s}} - {{projectsbystudent[s]}}">{{n}}</th>
      {% for p in projects %}
        <td class="{{tdstyle(s, p)}}" title="{{n}} - {{p}}">{{choices[(s, p)]}}</td>
      {% endfor %}
    </tr>
  {% endfor %}
</tbody>
</table>

<h1>Statistics with marks</h1>
<p>Class average: {{"%2.1f" % classavg}}</p>
<p>The bar charts indicate student marks minus class average -- red below class avg and blue above.</p>
<p>For reference, the whole class looks like this: {{markbar(sorted(flatmarks))}}</p>
<p>You can click on the headings to sort the tables.</p>

{# Assignment histogram
 # ====================================================================== #}

<h2>Assignment breakdown</h2>
<table>
<tr><th>Choice</th><th>N</th><th>Marks</th></tr>

{% for choice in ['P', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '.'] %}
    {% set m = marksbychoice(choice) %}
    <tr><td>{{choice}}</td><td>{{len(m)}}</td><td>{{markbar(m)}}</td></tr>
{% endfor %}
</table>
    
{# Translation has happened up to here

# Mark summary per lecturer
# ======================================================================
outfile.write(str(qt.h2("Statistics per lecturer")))
outfile.write("\n<table class='sortable'>\n")
outfile.write(str(qt.tr(qt.th(h) for h in ('Lecturer', 'Avg Mark', 'Breakdown', 'Number', 'Vetos', 'Pre', 'Popularity', 'Students'))))


def popscore(f):
    return 1/f if f > 0 else 1

for l in lecturers:
    m = sorted([float(marks[s]) for s in studentsbylecturer[l]])
    markavg = mean(m)
    msparkline = markbar(m)
    vetos = [i for i in choicesbylecturer[l] if i == 'V']
    nvetos = len(vetos)
    projectsbylecturer = [p for p in projects if Project(p).lecturer == l]
    nprojects = len(projectsbylecturer)
    preassignments = sum(1 for key in choices 
                           if choices[key] == 'P' and key[1] in projectsbylecturer)
    nassigned = nprojects - preassignments
    if nassigned > 0:
        popularity = sum([popscore(float(i)) 
                          for i in choicesbylecturer[l] 
                          if valid(i)])/float(nassigned)*10
    else:
        popularity = 0 
    data = [qt.td(l),
            qt.td('%2.1f' % markavg),
            qt.td(msparkline),
            qt.td(len(m)),
            qt.td('%2.1f' % (float(nvetos)/nprojects)),
            qt.td(preassignments),
            qt.td('%2.1f' % (popularity))]

    photos = []
    for s in studentsbylecturer[l]:
        p = projectsbystudent[s]
        title = ' '.join([studentnames[s], p, choices[(s,p)],
                          projectdescriptions[p]])
        photos.append(qt.tag('img', [], {'src': photopath(s),
                                         'alt': studentnames[s],
                                         'title': title,
                                         'width': '40'}))
    data.append(qt.td(photos))
    outfile.write(str(qt.tr(data)))
    
outfile.write("</table>\n")

# Per project
# ======================================================================
outfile.writelines([str(qt.h2('Statistics per project')),
                    str(qt.p("Here, the bar charts are for all the students who selected the project.")),
                    "<table class='sortable'>"])

breakdownvalues = ['P'] + [str(i) for i in range(1, 11)] + ['V']
row = [qt.th(e) for e in ['Project','Popularity', 'Marks', 'Breakdown'] \
                         + breakdownvalues + ['Total', 'Title']]
outfile.write(str(qt.tr(row)))
for p in projects:
    popularity = sum(popscore(float(choices[(s, p)])) for s in students if choices[(s,p)].isdigit())
    data = [qt.td(p), qt.td('%2.1f' % (popularity))]
    thesemarks = sorted(float(marks[s]) for s in students if choices[(s,p)].isdigit())
    data += [qt.td("%2.1f" % (mean(thesemarks))),
             qt.td(markbar(thesemarks))]
    data += [qt.td(sum([choices[(s, p)]==str(i) for s in students])) for i in breakdownvalues]
    data.append(qt.td(len(thesemarks)))
    data.append(qt.td(projectdescriptions[p]))
    outfile.write(str(qt.tr(data)))
                 
outfile.write("</table>\n")

# ======================================================================
outfile.writelines([str(qt.h2('Student satisfaction')),
                    str(qt.p('Who got their first choice, what were their marks, who got bad choices?')),
                   "<table class='sortable'>",
                   str(qt.tr(qt.th(k) for k in ('Number', 'Name', 'Mark', 'Choice', 'Project')))])
for s in students:
    p = projectsbystudent[s]
    outfile.writelines(str(qt.tr(qt.td(k) for k in (s, studentnames[s], "%2.1f" % float(marks[s]), choices[(s, p)], p))))
outfile.write("</table>\n")

# ======================================================================
outfile.writelines([str(qt.h2('Open projects')),
                    str(qt.p('Which projects can still be assigned without violating constraints'))])

outfile.write('<table>\n')
outfile.write(str(qt.tr([qt.th('Project'), qt.th('Description')])))
outfile.writelines([str(qt.tr([qt.td(p), qt.td(projectdescriptions[p])]))
                    for p in projects
                    if nstudentsbyproject[p] < int(maxperproject[p]) and len(studentsbylecturer[getlect(p)]) < int(maxperlecturer[getlect(p)])])
</table>

</body>
</html>

#}
